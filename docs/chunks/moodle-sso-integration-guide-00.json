{
  "id": "moodle-sso-integration-guide-00",
  "url": "https://dev.clever.com/docs/moodle-sso-integration-guide",
  "path": "/docs/moodle-sso-integration-guide",
  "section": "Guides",
  "title": "Moodle SSO Integration Guide",
  "heading": "Moodle SSO Integration Guide",
  "headingLevel": 0,
  "parentHeadings": [
    "Moodle SSO Integration Guide"
  ],
  "content": "Some of our application partners use the Moodle platform to deliver their content and manage courses. It may be helpful to build out Clever SSO integration to allow users to more easily access this content. While this integration can be set up with minimal development work, there are aspects of it that may still require engineering based on your needs.\n\n> ## ðŸ“˜\n> \n> SSO Integrations Only\n> \n> Please note that this guide is meant for Clever SSO integrations with Moodle only and does not include any guidance for rostering.\n\n## \n\nOAuth with Moodle\n\n[](#oauth-with-moodle)\n\n> ## ðŸš§\n> \n> Moodle Version\n> \n> This guide is written with version 4.0 in mind. If you are working with a different version of Moodle, some aspects may not apply.\n\nTo get SSO working, we will need to set up an OAuth connection. You will need administrator access. On the **Site administration** page, navigate to _Server_\n\n![](https://files.readme.io/a357ad1-image.png)\n\nNext, select \"OAuth 2 services\"\n\n![](https://files.readme.io/ab83bc2-image.png)\n\n### \n\nConfiguration - Clever\n\n[](#configuration---clever)\n\nIn newer versions of Moodle, you should see an option to create a new \"Clever\" service. Selecting this option, will pre-populate some fields in the configuration page. At this stage, all you need to do is provide a _Client ID_ and _Client secret_. These can be found in your Clever application developer dashboard **Settings.**\n\n![](https://files.readme.io/14cf3be-image.png)\n\n![](https://files.readme.io/6e55f16-image.png)\n\nOnce you've provided your client credentials, you are done! You have effectively set up SSO between your Moodle instance and Clever. Navigating to your login page, you should now see a Clever login button.\n\n![](https://files.readme.io/ee7a31f-image.png)\n\n### \n\nConfiguration - Custom\n\n[](#configuration---custom)\n\nIf you do not see the option to create a Clever service in your Moodle instance, select \"Custom\". You will have additional configuration steps involving authentication endpoints and field mappings. Please see the screenshots below:\n\n![Under \"Edit\", the second icon from the left represents endpoint configuration and the third represents field mappings.](https://files.readme.io/980b79a-image.png)\n\nUnder \"Edit\", the second icon from the left represents endpoint configuration and the third represents field mappings.\n\n![](https://files.readme.io/989c3eb-image.png)\n\nauthorization\\_endpoint: https://clever.com/oauth/authorize\n\ntoken\\_endpoint: <https://clever.com/oauth/tokens>\n\nuserinfo\\_endpoint: <https://api.clever.com/v3.0/me>\n\nuserdata\\_endpoint: <https://api.clever.com/v3.0/users>\n\n![](https://files.readme.io/2b58c71-image.png)\n\ndata-id: idnumber\n\ndata-name-first: firstname\n\ndata-name-last: lastname\n\ndata-email: email\n\nOnce you've set up the field mappings and\n\n### \n\nClever-initiated Logins and the State Param\n\n[](#clever-initiated-logins-and-the-state-param)\n\nMany Clever users will launch SSO from the Clever Portal, which is Clever's SSO launchpad page. See the screenshot below as an example:\n\n![](https://files.readme.io/f90a0d7-image.png)\n\nBy default, your Moodle-Clever SSO integration is unable to handle authentication requests that are kicked off from the Clever Portal. This is because Moodle requires a state parameter for authentication requests in order to prevent CSRF attacks.\n\nIf your integration is not set up to handle this, you will see the following error message when authentication is initiated from the Clever Portal into your Moodle instance.\n\n![](https://files.readme.io/728d38e-image.png)\n\nTo handle authentication requests initiated from the Clever Portal, we'll need to re-initiate the authentication request from our Moodle application with the state parameter appended. Clever will pass the state parameter through so all you need to do is adjust the authentication service to handle this use case.\n\nIn your Moodle source code files, navigate to **/admin/oauth2callback.php**.\n\nHere, you will want to process Clever-initiated SSO requests that are missing state parameters by creating a new request and formulating it to include a state parameter. See an example workflow below:\n\n```\n$state = optional_param('state', '', PARAM_RAW);\nif ($state == '') {\n    /*print_error('missing state');*/\n\n    $stateparams['wantsurl'] = new moodle_url('/');\n    $stateparams['sesskey'] = sesskey();\n    $stateparams['id'] = $issuer->get('id');\n//Include all relevant params for the new authentication request\n    $params = array_merge(\n        [\n            'client_id' => $issuer->get('clientid'),\n            'redirect_uri' => new moodle_url('/admin/oauth2callback.php'),\n            'response_type' => 'code',\n            'scope' => optional_param('scope', null, PARAM_RAW),\n            'code' => optional_param('code', null, PARAM_RAW),\n            'state' => new moodle_url('/auth/oauth2/login.php', $stateparams),\n        ]\n    );\n //Formulate a new SSO request URL with the necessary params\n    $backtocleverurl = new moodle_url($clever_url, $params);\n \n    error_log(\"*****************admincallback backtocleverurl redirect back to clever\");\n    error_log(print_r($backtocleverurl, true));\n    redirect($backtocleverurl);\n} else {\n// The authorization code generated by the authorization server.\n    $code = required_param('code', PARAM_RAW);\n// The state parameter we've given (used in moodle as a redirect url).\n    $state = required_param('state', PARAM_LOCALURL);\n    error_log(\"admincallback state\");\n    error_log(print_r($state, true));\n\n    $redirecturl = new moodle_url($state);\n    $params = $redirecturl->params();\n\n    if (isset($params['sesskey']) and confirm_sesskey($params['sesskey'])) {\n        $redirecturl->param('oauth2code', $code);\n        redirect($redirecturl);\n    } else {\n        print_error('invalidsesskey');\n    }\n}\n```",
  "tokenEstimate": 1454,
  "crawledAt": "2026-03-02T06:18:34.123Z",
  "fetchMethod": "static",
  "chunkIndex": 0,
  "totalChunks": 1
}